// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  avatar        String?
  level         Int      @default(1)
  totalPoints   Int      @default(0)
  streak        Int      @default(0)
  lastActiveAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  enrollments     UserEnrollment[]
  progress        MissionProgress[]
  hintUsages      HintUsage[]
  analytics       UserAnalytics[]
  achievements    UserAchievement[]
  codeSubmissions CodeSubmission[]
  portfolio       PortfolioProject[]

  @@map("users")
}

model SkillModule {
  id          String @id @default(cuid())
  title       String
  description String
  order       Int
  isLocked    Boolean @default(true)
  icon        String?
  color       String @default("#6366f1")
  
  // Relations
  missions     Mission[]
  enrollments  UserEnrollment[]
  prerequisites SkillModulePrerequisite[] @relation("ModulePrerequisites")
  dependents    SkillModulePrerequisite[] @relation("ModuleDependents")

  @@map("skill_modules")
}

model SkillModulePrerequisite {
  id              String @id @default(cuid())
  moduleId        String
  prerequisiteId  String
  
  module        SkillModule @relation("ModulePrerequisites", fields: [moduleId], references: [id], onDelete: Cascade)
  prerequisite  SkillModule @relation("ModuleDependents", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([moduleId, prerequisiteId])
  @@map("skill_module_prerequisites")
}

model Mission {
  id              String @id @default(cuid())
  title           String
  description     String
  context         String // Real-world scenario description
  type            MissionType
  difficulty      Difficulty
  points          Int @default(100)
  estimatedTime   Int // in minutes
  moduleId        String
  
  // Mission content
  dataset         Json? // CSV/JSON data structure
  brokenCode      Json? // Initial broken/incomplete code
  objectives      Json // Array of objectives
  constraints     Json? // Time, compute, accuracy constraints
  validationRules Json // Validation engine rules
  hints           Json // Hint system configuration
  
  // Metadata
  tags            String // JSON string array
  order           Int
  isPublished     Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  module          SkillModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        MissionProgress[]
  submissions     CodeSubmission[]
  hintUsages      HintUsage[]

  @@map("missions")
}

model UserEnrollment {
  id         String   @id @default(cuid())
  userId     String
  moduleId   String
  enrolledAt DateTime @default(now())
  completedAt DateTime?
  
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  module     SkillModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("user_enrollments")
}

model MissionProgress {
  id             String   @id @default(cuid())
  userId         String
  missionId      String
  status         ProgressStatus @default(NOT_STARTED)
  attempts       Int @default(0)
  bestScore      Float?
  currentScore   Float?
  completedAt    DateTime?
  lastAttemptAt  DateTime @default(now())
  timeSpent      Int @default(0) // in minutes
  
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission        Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  submissions    CodeSubmission[]

  @@unique([userId, missionId])
  @@map("mission_progress")
}

model CodeSubmission {
  id              String   @id @default(cuid())
  userId          String
  missionId       String
  progressId      String
  code            String
  language        String @default("python")
  testResults     Json?
  score           Float?
  feedback        String?
  isCorrect       Boolean @default(false)
  submittedAt     DateTime @default(now())
  executionTime   Int? // in milliseconds
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission         Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  progress        MissionProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("code_submissions")
}

model HintUsage {
  id          String   @id @default(cuid())
  userId      String
  missionId   String
  hintLevel   Int
  hintContent String
  usedAt      DateTime @default(now())
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission     Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@map("hint_usages")
}

model Achievement {
  id          String @id @default(cuid())
  title       String
  description String
  icon        String
  badgeColor  String @default("#f59e0b")
  criteria    Json // Conditions to unlock
  points      Int @default(50)
  
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())
  
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model UserAnalytics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  
  // Learning metrics
  missionsCompleted  Int @default(0)
  totalAttempts      Int @default(0)
  averageScore       Float @default(0)
  timeSpent          Int @default(0) // minutes
  
  // Skill metrics
  bugFixes           Int @default(0)
  modelsImproved     Int @default(0)
  dataCleaned        Int @default(0)
  algorithmsChosen   Int @default(0)
  
  // Behavior metrics
  hintUsage          Int @default(0)
  streakDays         Int @default(0)
  preferredMissionType String?
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("user_analytics")
}

model PortfolioProject {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  code        String
  results     Json?
  missionId   String?
  isPublic    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("portfolio_projects")
}

enum MissionType {
  MODEL_DEBUG
  DATA_QUALITY
  ALGORITHM_SELECTION
  MATH_IN_CODE
  TRAINING_OPTIMIZATION
  EVALUATION_METRICS
  ML_SECURITY
  DEPLOYMENT
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  MASTERED
}