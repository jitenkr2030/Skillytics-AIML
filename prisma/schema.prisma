// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  avatar        String?
  level         Int      @default(1)
  totalPoints   Int      @default(0)
  streak        Int      @default(0)
  lastActiveAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Subscription fields
  subscriptionTier      SubscriptionTier @default(FREE)
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  credits               Int      @default(0)

  // Organization relationship
  organizationId        String?
  organizationRole      OrganizationRole? @default(MEMBER)

  // Relations
  enrollments       UserEnrollment[]
  progress          MissionProgress[]
  hintUsages        HintUsage[]
  analytics         UserAnalytics[]
  achievements      UserAchievement[]
  codeSubmissions   CodeSubmission[]
  portfolio         PortfolioProject[]
  certifications    UserCertification[]
  marketplacePurchases MarketplacePurchase[]
  creatorProfile    MarketplaceCreator?
  payouts           CreatorPayout[]

  @@map("users")
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum OrganizationRole {
  MEMBER
  ADMIN
  OWNER
}

model SkillModule {
  id          String @id @default(cuid())
  title       String
  description String
  order       Int
  isLocked    Boolean @default(true)
  icon        String?
  color       String @default("#6366f1")
  
  // Relations
  missions     Mission[]
  enrollments  UserEnrollment[]
  prerequisites SkillModulePrerequisite[] @relation("ModulePrerequisites")
  dependents    SkillModulePrerequisite[] @relation("ModuleDependents")

  @@map("skill_modules")
}

model SkillModulePrerequisite {
  id              String @id @default(cuid())
  moduleId        String
  prerequisiteId  String
  
  module        SkillModule @relation("ModulePrerequisites", fields: [moduleId], references: [id], onDelete: Cascade)
  prerequisite  SkillModule @relation("ModuleDependents", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([moduleId, prerequisiteId])
  @@map("skill_module_prerequisites")
}

model Mission {
  id              String @id @default(cuid())
  title           String
  description     String
  context         String // Real-world scenario description
  type            MissionType
  difficulty      Difficulty
  points          Int @default(100)
  estimatedTime   Int // in minutes
  moduleId        String
  
  // Mission content
  dataset         Json? // CSV/JSON data structure
  brokenCode      Json? // Initial broken/incomplete code
  objectives      Json // Array of objectives
  constraints     Json? // Time, compute, accuracy constraints
  validationRules Json // Validation engine rules
  hints           Json // Hint system configuration
  
  // Metadata
  tags            String // JSON string array
  order           Int
  isPublished     Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  module          SkillModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        MissionProgress[]
  submissions     CodeSubmission[]
  hintUsages      HintUsage[]

  @@map("missions")
}

model UserEnrollment {
  id         String   @id @default(cuid())
  userId     String
  moduleId   String
  enrolledAt DateTime @default(now())
  completedAt DateTime?
  
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  module     SkillModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("user_enrollments")
}

model MissionProgress {
  id             String   @id @default(cuid())
  userId         String
  missionId      String
  status         ProgressStatus @default(NOT_STARTED)
  attempts       Int @default(0)
  bestScore      Float?
  currentScore   Float?
  completedAt    DateTime?
  lastAttemptAt  DateTime @default(now())
  timeSpent      Int @default(0) // in minutes
  
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission        Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  submissions    CodeSubmission[]

  @@unique([userId, missionId])
  @@map("mission_progress")
}

model CodeSubmission {
  id              String   @id @default(cuid())
  userId          String
  missionId       String
  progressId      String
  code            String
  language        String @default("python")
  testResults     Json?
  score           Float?
  feedback        String?
  isCorrect       Boolean @default(false)
  submittedAt     DateTime @default(now())
  executionTime   Int? // in milliseconds
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission         Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  progress        MissionProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("code_submissions")
}

model HintUsage {
  id          String   @id @default(cuid())
  userId      String
  missionId   String
  hintLevel   Int
  hintContent String
  usedAt      DateTime @default(now())
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission     Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@map("hint_usages")
}

model Achievement {
  id          String @id @default(cuid())
  title       String
  description String
  icon        String
  badgeColor  String @default("#f59e0b")
  criteria    Json // Conditions to unlock
  points      Int @default(50)
  
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())
  
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model UserAnalytics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  
  // Learning metrics
  missionsCompleted  Int @default(0)
  totalAttempts      Int @default(0)
  averageScore       Float @default(0)
  timeSpent          Int @default(0) // minutes
  
  // Skill metrics
  bugFixes           Int @default(0)
  modelsImproved     Int @default(0)
  dataCleaned        Int @default(0)
  algorithmsChosen   Int @default(0)
  
  // Behavior metrics
  hintUsage          Int @default(0)
  streakDays         Int @default(0)
  preferredMissionType String?
  
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("user_analytics")
}

model PortfolioProject {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  code        String
  results     Json?
  missionId   String?
  isPublic    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("portfolio_projects")
}

enum MissionType {
  MODEL_DEBUG
  DATA_QUALITY
  ALGORITHM_SELECTION
  MATH_IN_CODE
  TRAINING_OPTIMIZATION
  EVALUATION_METRICS
  ML_SECURITY
  DEPLOYMENT
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  MASTERED
}

// ============================================
// ORGANIZATION & ENTERPRISE MODELS
// ============================================

model Organization {
  id              String   @id @default(cuid())
  name            String
  domain          String?  @unique
  logo            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // SSO Configuration
  ssoProvider     String?
  ssoConfig       String?
  ssoEnabled      Boolean  @default(false)

  // Enterprise settings
  maxSeats        Int      @default(10)

  // Relations
  members         User[]
  teamAnalytics   TeamAnalytics[]
  learningPaths   LearningPath[]
  invitations     OrganizationInvitation[]

  @@map("organizations")
}

model OrganizationInvitation {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           OrganizationRole @default(MEMBER)
  token          String   @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_invitations")
}

model TeamAnalytics {
  id             String   @id @default(cuid())
  organizationId String
  date           DateTime @default(now())

  // Aggregated metrics
  totalMembers       Int     @default(0)
  activeMembers      Int     @default(0)
  missionsCompleted  Int     @default(0)
  averageProgress    Float   @default(0)
  totalTimeSpent     Int     @default(0)

  // Skill distribution
  skillBreakdown     String?

  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
  @@map("team_analytics")
}

model LearningPath {
  id             String   @id @default(cuid())
  organizationId String
  title          String
  description    String
  moduleIds      String
  targetDeadline DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("learning_paths")
}

// ============================================
// CERTIFICATION MODELS
// ============================================

model Certification {
  id              String   @id @default(cuid())
  name            String
  description     String
  type            CertificationType
  image           String?

  requiredMissions   String   @default("[]")
  requiredModules    String   @default("[]")
  minimumScore       Float    @default(80.0)

  isActive        Boolean  @default(true)
  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userCertifications UserCertification[]

  @@map("certifications")
}

enum CertificationType {
  GENERAL
  DATA_SCIENTIST
  MLOPS_ENGINEER
  COMPUTER_VISION
  NLP_ENGINEER
  CAREER_READY
}

model UserCertification {
  id              String   @id @default(cuid())
  userId          String
  certificationId String

  certificateHash String   @unique
  issueDate       DateTime @default(now())
  expiryDate      DateTime?
  score           Float?

  verificationUrl String?
  pdfPath         String?

  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  certification   Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)

  @@unique([userId, certificationId])
  @@map("user_certifications")
}

// ============================================
// MARKETPLACE MODELS
// ============================================

model MarketplaceCreator {
  id              String   @id @default(cuid())
  userId          String   @unique

  bio             String?
  website         String?
  twitter         String?
  github          String?

  payoutMethod    String?
  payoutDetails   String?

  totalEarnings   Float    @default(0)
  pendingPayout   Float    @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           MarketplaceItem[]
  payouts         CreatorPayout[]

  @@map("marketplace_creators")
}

model MarketplaceItem {
  id              String   @id @default(cuid())
  creatorId       String

  title           String
  description     String
  type            MarketplaceItemType
  category        String
  tags            String   @default("[]")

  price           Float    @default(0)
  currency        String   @default("USD")
  isFree          Boolean  @default(false)

  content         String
  previewContent  String?
  fileUrls        String   @default("[]")

  status          MarketplaceItemStatus @default(DRAFT)
  moderationNotes String?

  averageRating   Float    @default(0)
  totalReviews    Int      @default(0)
  totalSales      Int      @default(0)

  revenueShare    Float    @default(0.6)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  creator         MarketplaceCreator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  reviews         MarketplaceReview[]
  purchases       MarketplacePurchase[]

  @@map("marketplace_items")
}

enum MarketplaceItemType {
  MISSION_PACK
  STUDY_GUIDE
  VIDEO_COURSE
  TEMPLATE
  PRACTICE_EXAM
  INTERVIEW_PREP
}

enum MarketplaceItemStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

model MarketplaceReview {
  id              String   @id @default(cuid())
  itemId          String
  userId          String

  rating          Int
  title           String?
  content         String

  isVerified      Boolean  @default(false)

  createdAt       DateTime @default(now())

  item            MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
  @@map("marketplace_reviews")
}

model MarketplacePurchase {
  id              String   @id @default(cuid())
  userId          String
  itemId          String

  amount          Float
  currency        String   @default("USD")
  paymentMethod   String?
  stripePaymentId String?

  purchasedAt     DateTime @default(now())
  accessExpires   DateTime?

  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item            MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("marketplace_purchases")
}

model CreatorPayout {
  id              String   @id @default(cuid())
  creatorId       String

  amount          Float
  currency        String   @default("USD")
  status          PayoutStatus @default(PENDING)

  items           String   @default("[]")

  processedAt     DateTime?
  transactionId   String?

  createdAt       DateTime @default(now())

  creator         MarketplaceCreator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("creator_payouts")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// BILLING MODELS
// ============================================

model SubscriptionPlan {
  id              String   @id @default(cuid())
  name            String
  tier            SubscriptionTier
  description     String

  monthlyPrice    Float
  annualPrice     Float
  currency        String   @default("USD")

  features        String   @default("[]")

  maxMissions     Int      @default(40)
  hasAnalytics    Boolean  @default(false)
  hasCertifications Boolean @default(false)
  hasSupport      Boolean  @default(false)

  stripeMonthlyPriceId String?
  stripeAnnualPriceId  String?

  isActive        Boolean  @default(true)
  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("subscription_plans")
}

model PaymentTransaction {
  id              String   @id @default(cuid())
  userId          String

  amount          Float
  currency        String   @default("USD")
  type            PaymentType
  status          PaymentStatus @default(PENDING)

  stripePaymentIntentId String?
  stripeInvoiceId String?

  description     String?
  metadata        String?

  createdAt       DateTime @default(now())
  processedAt     DateTime?

  @@map("payment_transactions")
}

enum PaymentType {
  SUBSCRIPTION
  ONE_TIME
  MARKETPLACE
  REFUND
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================
// EVENT LOGGING
// ============================================

model MonetizationEvent {
  id              String   @id @default(cuid())
  userId          String?
  eventType       String
  eventData       String   @default("{}")

  amount          Float?
  currency        String?

  createdAt       DateTime @default(now())

  @@index([userId, eventType])
  @@map("monetization_events")
}